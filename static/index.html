<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HYMN Simulator</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  /* Dark Theme (Default) - Warm Vintage Palette */
  --bg: #1c1917;
  --panel: #262220;
  --panel-alt: #2d2926;
  --border: #3d3835;
  --border-light: #4a4541;

  --text: #e8e4df;
  --text-secondary: #c4beb6;
  --muted: #7a746c;

  --gold: #d4a34b;
  --gold-dim: #a67c35;
  --teal: #6b9b8f;
  --teal-dim: #4a7268;
  --rust: #c47a5a;
  --rust-dim: #8f5a42;
}

:root.light {
  /* Light Theme */
  --bg: #f5f3f0;
  --panel: #ffffff;
  --panel-alt: #faf9f7;
  --border: #e0ddd8;
  --border-light: #d0ccc6;

  --text: #1c1917;
  --text-secondary: #4a4541;
  --muted: #7a746c;

  --gold: #b8862f;
  --gold-dim: #8a6420;
  --teal: #4a7a6e;
  --teal-dim: #3a5f55;
  --rust: #a85d3f;
  --rust-dim: #7a4530;
}

html, body {
  height: 100%;
  font-family: 'JetBrains Mono', monospace;
  background: var(--bg);
  color: var(--text);
  font-size: 13px;
  line-height: 1.5;
}

/* Subtle texture overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%' height='100%' filter='url(%23noise)'/%3E%3C/svg%3E");
  opacity: 0.03;
  pointer-events: none;
  z-index: 1000;
}

.app {
  display: grid;
  grid-template-rows: auto 1fr auto;
  height: 100vh;
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  gap: 16px;
}

/* HEADER */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 2px;
}

.logo {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo-icon {
  width: 36px;
  height: 36px;
  background: var(--gold);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: var(--bg);
  font-size: 16px;
  border-radius: 2px;
}

h1 {
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
  letter-spacing: 3px;
}

.tagline {
  font-size: 11px;
  color: var(--muted);
  margin-top: 2px;
  letter-spacing: 1px;
}

.status {
  font-size: 12px;
  color: var(--muted);
  padding: 8px 16px;
  background: var(--panel-alt);
  border-radius: 2px;
  border: 1px solid var(--border);
}

.status.running {
  color: var(--teal);
  border-color: var(--teal-dim);
}
.status.halted {
  color: var(--rust);
  border-color: var(--rust-dim);
}

/* MAIN GRID */
main {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr auto;
  gap: 16px;
  overflow: hidden;
}

/* PANELS */
.panel {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 2px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.panel-header {
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-secondary);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--panel-alt);
}

.panel-header .badge {
  font-size: 10px;
  color: var(--muted);
  background: var(--bg);
  padding: 4px 10px;
  border-radius: 2px;
  letter-spacing: 1px;
}

.panel-body {
  flex: 1;
  overflow-y: auto;
  padding: 0;
}

/* Scrollbar */
.panel-body::-webkit-scrollbar {
  width: 8px;
}
.panel-body::-webkit-scrollbar-track {
  background: var(--panel);
}
.panel-body::-webkit-scrollbar-thumb {
  background: var(--border-light);
  border-radius: 4px;
}

/* CODE EDITOR */
#code {
  width: 100%;
  height: 100%;
  border: none;
  background: transparent;
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  line-height: 1.9;
  padding: 20px;
  resize: none;
  outline: none;
}

#code::placeholder {
  color: var(--muted);
}

/* MEMORY VIEW */
.memory-table {
  width: 100%;
  font-size: 12px;
}

.memory-row {
  display: grid;
  grid-template-columns: 44px 1fr 56px 80px;
  border-bottom: 1px solid var(--border);
  transition: background 0.15s;
}

.memory-row:hover {
  background: var(--panel-alt);
}

.memory-row.current {
  background: var(--teal-dim);
  border-left: 3px solid var(--teal);
}

.memory-row.current .mem-addr { color: var(--teal); }
.memory-row.current .mem-instr { color: var(--text); }
.memory-row.current .mem-dec { color: var(--text); }
.memory-row.current .mem-bin { color: var(--text-secondary); }

.memory-row.header {
  background: var(--bg);
  color: var(--muted);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  position: sticky;
  top: 0;
  z-index: 1;
  border-bottom: 1px solid var(--border-light);
}

.memory-row.header:hover {
  background: var(--bg);
}

.mem-addr, .mem-instr, .mem-dec, .mem-bin {
  padding: 10px 12px;
}

.mem-addr {
  color: var(--muted);
  text-align: right;
  font-size: 11px;
  border-right: 1px solid var(--border);
}

.mem-instr {
  color: var(--teal);
  padding-left: 16px;
}

.memory-row.is-data .mem-instr {
  color: var(--muted);
  font-style: italic;
}

.mem-dec {
  text-align: right;
  color: var(--gold);
  border-left: 1px solid var(--border);
}

.mem-bin {
  font-size: 11px;
  color: var(--muted);
  letter-spacing: 0.5px;
  border-left: 1px solid var(--border);
  font-variant-numeric: tabular-nums;
}

/* Clickable bits */
.bit {
  cursor: pointer;
  padding: 1px 2px;
  border-radius: 2px;
  transition: all 0.1s;
  display: inline-block;
  min-width: 10px;
  text-align: center;
}

.bit:hover {
  background: var(--teal-dim);
  color: var(--text);
}

.bit.one {
  color: var(--gold);
}

.register-binary .bit {
  padding: 2px 3px;
  font-size: 12px;
}

.register-binary .bit:hover {
  background: var(--gold-dim);
}

/* Input Prompt Overlay */
.input-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: 100;
  align-items: center;
  justify-content: center;
}

.input-overlay.active {
  display: flex;
}

.input-prompt {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 2px;
  padding: 32px;
  max-width: 400px;
  width: 90%;
  text-align: center;
}

.input-prompt h3 {
  font-size: 14px;
  font-weight: 600;
  color: var(--gold);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 8px;
}

.input-prompt p {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 20px;
}

.input-prompt-field {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: center;
}

.input-prompt-field .prompt-symbol {
  font-size: 24px;
  color: var(--teal);
  font-weight: 600;
}

.input-prompt-field input {
  flex: 1;
  max-width: 120px;
  padding: 12px 16px;
  font-family: inherit;
  font-size: 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 2px;
  color: var(--text);
  text-align: center;
  outline: none;
}

.input-prompt-field input:focus {
  border-color: var(--teal);
}

.input-prompt-field button {
  padding: 12px 20px;
  flex: none;
}

.input-prompt .hint {
  font-size: 10px;
  color: var(--muted);
  margin-top: 16px;
}

/* REGISTERS */
.registers-panel {
  grid-column: 1 / -1;
}

.registers-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  padding: 16px;
}

.register {
  background: var(--panel-alt);
  padding: 20px;
  text-align: center;
  border: 1px solid var(--border);
  border-radius: 2px;
}

.register-label {
  font-size: 10px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--muted);
  margin-bottom: 12px;
}

.register-value {
  font-size: 28px;
  font-weight: 500;
  color: var(--gold);
  font-variant-numeric: tabular-nums;
}

.register-binary {
  font-size: 11px;
  color: var(--muted);
  margin-top: 8px;
  letter-spacing: 1px;
  font-variant-numeric: tabular-nums;
}

.register.changed .register-value {
  color: var(--rust);
}

/* I/O Registers */
.register.io .register-value {
  font-size: 14px;
  color: var(--text-secondary);
}

.io-input {
  background: transparent;
  border: none;
  outline: none;
  font-family: inherit;
  font-size: 14px;
  color: var(--teal);
  width: 100%;
  text-align: center;
}

.io-input::placeholder {
  color: var(--muted);
}

.io-output {
  color: var(--gold);
  min-height: 21px;
}

.io-output:empty::before {
  content: '—';
  color: var(--muted);
}

/* FOOTER */
footer {
  display: flex;
  gap: 12px;
}

button {
  flex: 1;
  padding: 16px 24px;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--text-secondary);
  font-family: inherit;
  font-size: 12px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 2px;
  cursor: pointer;
  transition: all 0.15s;
  border-radius: 2px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

button:hover {
  background: var(--panel-alt);
  border-color: var(--border-light);
  color: var(--text);
}

button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

button:disabled:hover {
  background: var(--panel);
  border-color: var(--border);
  color: var(--text-secondary);
}

button.primary {
  background: var(--gold);
  border-color: var(--gold);
  color: var(--bg);
}

button.primary:hover {
  background: var(--gold-dim);
  border-color: var(--gold-dim);
}

button .shortcut {
  font-size: 10px;
  padding: 3px 8px;
  background: rgba(0,0,0,0.2);
  border-radius: 2px;
  opacity: 0.8;
}

/* THEME TOGGLE */
.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.nav-links {
  display: flex;
  gap: 8px;
}

.nav-links a {
  padding: 8px 12px;
  color: var(--text-secondary);
  text-decoration: none;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  border: 1px solid var(--border);
  border-radius: 2px;
  transition: all 0.15s;
}

.nav-links a:hover {
  color: var(--text);
  border-color: var(--border-light);
  background: var(--panel-alt);
}

.theme-toggle {
  width: 36px;
  height: 36px;
  border: 1px solid var(--border);
  background: var(--panel-alt);
  color: var(--text-secondary);
  border-radius: 2px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: all 0.15s;
}

.theme-toggle:hover {
  color: var(--gold);
  border-color: var(--gold-dim);
}

/* RESPONSIVE */
@media (max-width: 900px) {
  main {
    grid-template-columns: 1fr;
  }
  .registers-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  .app {
    padding: 12px;
  }
  .nav-links {
    display: none;
  }
}
</style>
</head>
<body>

<div class="app">
  <header>
    <div class="logo">
      <div class="logo-icon">H</div>
      <div>
        <h1>HYMN SIMULATOR</h1>
        <div class="tagline">Hypothetical Machine</div>
      </div>
    </div>
    <div class="header-right">
      <div class="status" id="status">Ready</div>
      <nav class="nav-links">
        <a href="/docs">Docs</a>
        <a href="/credits">Credits</a>
      </nav>
      <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
        <span id="theme-icon">&#9790;</span>
      </button>
    </div>
  </header>

  <main>
    <!-- CODE PANEL -->
    <div class="panel">
      <div class="panel-header">
        Source Code
        <span class="badge">Assembly</span>
      </div>
      <div class="panel-body">
        <textarea id="code" placeholder="# Type your assembly code here" spellcheck="false"></textarea>
      </div>
    </div>

    <!-- MEMORY PANEL -->
    <div class="panel">
      <div class="panel-header">
        Memory
        <span class="badge">30 Locations</span>
      </div>
      <div class="panel-body">
        <div class="memory-table" id="memory">
          <div class="memory-row header">
            <div class="mem-addr">Addr</div>
            <div class="mem-instr">Instruction</div>
            <div class="mem-dec">Dec</div>
            <div class="mem-bin">Binary</div>
          </div>
        </div>
      </div>
    </div>

    <!-- REGISTERS -->
    <div class="panel registers-panel">
      <div class="registers-grid">
        <div class="register" id="reg-pc">
          <div class="register-label">Program Counter</div>
          <div class="register-value">0</div>
          <div class="register-binary">00000</div>
        </div>
        <div class="register" id="reg-ac">
          <div class="register-label">Accumulator</div>
          <div class="register-value">0</div>
          <div class="register-binary">00000000</div>
        </div>
        <div class="register io">
          <div class="register-label">Input History</div>
          <div class="io-output" id="input-history"></div>
        </div>
        <div class="register io">
          <div class="register-label">Output</div>
          <div class="io-output" id="output"></div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <button id="btn-load" class="primary">
      Load
      <span class="shortcut">⌘↵</span>
    </button>
    <button id="btn-step" disabled>
      Step
      <span class="shortcut">⌘S</span>
    </button>
    <button id="btn-run" disabled>
      Run
      <span class="shortcut">⌘R</span>
    </button>
    <button id="btn-reset" disabled>
      Reset
      <span class="shortcut">Esc</span>
    </button>
  </footer>
</div>

<!-- Input Prompt Overlay -->
<div class="input-overlay" id="input-overlay">
  <div class="input-prompt">
    <h3>Input Required</h3>
    <p>The READ instruction needs a value from input.</p>
    <div class="input-prompt-field">
      <span class="prompt-symbol">?</span>
      <input type="number" id="input-value" placeholder="0" min="-128" max="127">
      <button id="btn-submit-input" class="primary">Enter</button>
    </div>
    <div class="hint">Enter a value between -128 and 127</div>
  </div>
</div>

<script>
// Theme handling
function initTheme() {
  const saved = localStorage.getItem('hymn-theme');
  if (saved === 'light') {
    document.documentElement.classList.add('light');
    document.getElementById('theme-icon').innerHTML = '&#9728;'; // sun
  }
}

function toggleTheme() {
  const isLight = document.documentElement.classList.toggle('light');
  localStorage.setItem('hymn-theme', isLight ? 'light' : 'dark');
  document.getElementById('theme-icon').innerHTML = isLight ? '&#9728;' : '&#9790;'; // sun/moon
}

// Initialize theme immediately
initTheme();

let state = null;
let prevAC = 0;

const $ = id => document.getElementById(id);

async function apiPost(path, payload = {}) {
  return fetch(path, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
}

function toBinary(n, bits) {
  if (n < 0) n = (1 << bits) + n;
  return n.toString(2).padStart(bits, '0');
}

function fromBinary(binStr, bits) {
  let val = parseInt(binStr, 2);
  // Handle signed conversion for 8-bit values
  if (bits === 8 && val >= 128) {
    val = val - 256;
  }
  return val;
}

function renderClickableBits(binary, onClick) {
  return binary.split('').map((bit, idx) => {
    const span = document.createElement('span');
    span.className = 'bit' + (bit === '1' ? ' one' : '');
    span.textContent = bit;
    span.onclick = (e) => {
      e.stopPropagation();
      onClick(idx);
    };
    return span;
  });
}

async function updateMemoryBit(address, bitIndex) {
  const mem = state.memory[address];
  const binary = toBinary(mem.decimal, 8);
  const bits = binary.split('');
  bits[bitIndex] = bits[bitIndex] === '0' ? '1' : '0';
  const newBinary = bits.join('');
  const newDecimal = fromBinary(newBinary, 8);

  try {
    const res = await apiPost('/api/memory', { address, decimal: newDecimal });
    const data = await res.json();
    if (!data.error) {
      updateUI(data);
    }
  } catch (e) {
    console.error('Failed to update memory:', e);
  }
}

async function updateRegisterBit(register, bitIndex) {
  const bits = register === 'pc' ? 5 : 8;
  const currentValue = register === 'pc' ? state.pc : state.ac;
  const binary = toBinary(currentValue, bits);
  const bitArr = binary.split('');
  bitArr[bitIndex] = bitArr[bitIndex] === '0' ? '1' : '0';
  const newBinary = bitArr.join('');
  const newValue = fromBinary(newBinary, bits);

  try {
    const res = await apiPost('/api/register', { register, value: newValue });
    const data = await res.json();
    if (!data.error) {
      updateUI(data);
    }
  } catch (e) {
    console.error('Failed to update register:', e);
  }
}

// Input prompt handling
function showInputPrompt() {
  $('input-overlay').classList.add('active');
  $('input-value').value = '';
  $('input-value').focus();
}

function hideInputPrompt() {
  $('input-overlay').classList.remove('active');
}

async function submitInput() {
  const inputEl = $('input-value');
  const value = parseInt(inputEl.value, 10);

  if (isNaN(value) || value < -128 || value > 127) {
    inputEl.style.borderColor = 'var(--rust)';
    setTimeout(() => inputEl.style.borderColor = '', 500);
    return;
  }

  hideInputPrompt();
  inputHistory.push(value);
  $('input-history').textContent = inputHistory.join(', ');

  try {
    const res = await apiPost('/api/input', { value });
    const data = await res.json();
    if (!data.error) {
      updateUI(data);
      // If we were running, continue running after input
      if (wasRunning) {
        wasRunning = false;
        run();
      }
    }
  } catch (e) {
    console.error('Failed to submit input:', e);
  }
}

let wasRunning = false;
let inputHistory = [];

function initMemory() {
  const container = $('memory');
  const header = container.querySelector('.header');
  container.innerHTML = '';
  container.appendChild(header);

  for (let i = 0; i < 30; i++) {
    const row = document.createElement('div');
    row.className = 'memory-row';
    row.id = `mem-${i}`;
    row.innerHTML = `
      <div class="mem-addr">${i.toString().padStart(2, '0')}</div>
      <div class="mem-instr">halt 0</div>
      <div class="mem-dec">0</div>
      <div class="mem-bin">00000000</div>
    `;
    container.appendChild(row);
  }
}

function updateMemory(data) {
  for (let i = 0; i < 30; i++) {
    const row = $(`mem-${i}`);
    const mem = data.memory[i];

    const isData = mem.instr.startsWith('halt') && mem.decimal !== 0;

    row.classList.toggle('current', i === data.pc && !data.halted);
    row.classList.toggle('is-data', isData);

    row.querySelector('.mem-instr').textContent = isData ? `data` : mem.instr;
    row.querySelector('.mem-dec').textContent = mem.decimal;

    // Render clickable bits
    const binCell = row.querySelector('.mem-bin');
    binCell.innerHTML = '';
    const binary = toBinary(mem.decimal, 8);
    const address = i;
    const bitSpans = renderClickableBits(binary, (bitIndex) => updateMemoryBit(address, bitIndex));
    bitSpans.forEach(span => binCell.appendChild(span));
  }

  if (!data.halted) {
    const currentRow = $(`mem-${data.pc}`);
    currentRow?.scrollIntoView({ block: 'center', behavior: 'smooth' });
  }
}

function updateRegisters(data) {
  const pcReg = $('reg-pc');
  pcReg.querySelector('.register-value').textContent = data.pc;

  // Render clickable PC bits
  const pcBinEl = pcReg.querySelector('.register-binary');
  pcBinEl.innerHTML = '';
  const pcBinary = toBinary(data.pc, 5);
  const pcBitSpans = renderClickableBits(pcBinary, (bitIndex) => updateRegisterBit('pc', bitIndex));
  pcBitSpans.forEach(span => pcBinEl.appendChild(span));

  const acReg = $('reg-ac');
  acReg.querySelector('.register-value').textContent = data.ac;

  // Render clickable AC bits
  const acBinEl = acReg.querySelector('.register-binary');
  acBinEl.innerHTML = '';
  const acBinary = toBinary(data.ac, 8);
  const acBitSpans = renderClickableBits(acBinary, (bitIndex) => updateRegisterBit('ac', bitIndex));
  acBitSpans.forEach(span => acBinEl.appendChild(span));

  if (state && data.ac !== prevAC) {
    acReg.classList.add('changed');
    setTimeout(() => acReg.classList.remove('changed'), 500);
  }
  prevAC = data.ac;

  $('output').textContent = data.output.join(', ');
}

function updateStatus(data) {
  const status = $('status');
  if (data.error) {
    status.textContent = data.error;
    status.className = 'status halted';
  } else if (data.halted) {
    status.textContent = 'Halted';
    status.className = 'status halted';
  } else if (data.waiting_for_input) {
    status.textContent = 'Waiting for input...';
    status.className = 'status running';
  } else {
    const mem = data.memory[data.pc];
    status.textContent = `Executing: ${mem.instr}`;
    status.className = 'status running';
  }
}

function updateUI(data) {
  state = data;
  updateMemory(data);
  updateRegisters(data);
  updateStatus(data);

  // Handle input prompt
  if (data.waiting_for_input) {
    showInputPrompt();
  } else {
    hideInputPrompt();
  }

  $('btn-step').disabled = data.halted || data.error || data.waiting_for_input;
  $('btn-run').disabled = data.halted || data.error || data.waiting_for_input;
}

function setMode(mode) {
  if (mode === 'edit') {
    $('btn-load').disabled = false;
    $('btn-load').classList.add('primary');
    $('btn-step').disabled = true;
    $('btn-run').disabled = true;
    $('btn-reset').disabled = true;
    $('code').disabled = false;
    $('status').textContent = 'Ready';
    $('status').className = 'status';
  } else {
    $('btn-load').disabled = true;
    $('btn-load').classList.remove('primary');
    $('btn-step').disabled = false;
    $('btn-run').disabled = false;
    $('btn-reset').disabled = false;
    $('code').disabled = true;
  }
}

async function load() {
  const code = $('code').value;

  try {
    const res = await apiPost('/api/load', { code, input: [] });
    const data = await res.json();

    if (data.error) {
      $('status').textContent = data.error;
      $('status').className = 'status halted';
      return;
    }

    prevAC = 0;
    state = null;
    inputHistory = [];
    $('input-history').textContent = '';
    setMode('loaded');
    updateUI(data);

  } catch (e) {
    $('status').textContent = 'Connection error';
    $('status').className = 'status halted';
  }
}

async function step() {
  try {
    const res = await apiPost('/api/step');
    const data = await res.json();
    if (data.error) {
      $('status').textContent = data.error;
      $('status').className = 'status halted';
      return;
    }
    updateUI(data);
  } catch (e) {
    $('status').textContent = 'Connection error';
    $('status').className = 'status halted';
  }
}

async function run() {
  wasRunning = true;
  try {
    const res = await apiPost('/api/run');
    const data = await res.json();
    if (data.error) {
      wasRunning = false;
      $('status').textContent = data.error;
      $('status').className = 'status halted';
      return;
    }
    // If waiting for input, keep wasRunning true; otherwise reset
    if (!data.waiting_for_input) {
      wasRunning = false;
    }
    updateUI(data);
  } catch (e) {
    wasRunning = false;
    $('status').textContent = 'Connection error';
    $('status').className = 'status halted';
  }
}

async function reset() {
  await apiPost('/api/reset');
  state = null;
  prevAC = 0;
  wasRunning = false;
  inputHistory = [];
  $('output').textContent = '';
  $('input-history').textContent = '';
  hideInputPrompt();
  initMemory();
  setMode('edit');
}

$('btn-load').onclick = load;
$('btn-step').onclick = step;
$('btn-run').onclick = run;
$('btn-reset').onclick = reset;
$('theme-toggle').onclick = toggleTheme;
$('btn-submit-input').onclick = submitInput;
$('input-value').onkeydown = (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    submitInput();
  }
};

document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && e.metaKey) {
    e.preventDefault();
    if (!$('btn-load').disabled) load();
  }
  if (e.key === 's' && e.metaKey) {
    e.preventDefault();
    if (!$('btn-step').disabled) step();
  }
  if (e.key === 'r' && e.metaKey) {
    e.preventDefault();
    if (!$('btn-run').disabled) run();
  }
  if (e.key === 'Escape') {
    if (!$('btn-reset').disabled) reset();
  }
});

initMemory();
setMode('edit');

// Initialize CPU state so bits are editable from the start
(async function initState() {
  try {
    const res = await apiPost('/api/load', { code: 'halt', input: [] });
    const data = await res.json();
    if (!data.error) {
      state = data;
      updateMemory(data);
      updateRegisters(data);
    }
  } catch (e) {}
  setMode('edit');
})();
</script>

</body>
</html>
