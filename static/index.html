<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HYMN Simulator</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  /* Warm Vintage Palette */
  --bg: #1c1917;
  --panel: #262220;
  --panel-alt: #2d2926;
  --border: #3d3835;
  --border-light: #4a4541;

  --text: #e8e4df;
  --text-secondary: #c4beb6;
  --muted: #7a746c;

  --gold: #d4a34b;
  --gold-dim: #a67c35;
  --teal: #6b9b8f;
  --teal-dim: #4a7268;
  --rust: #c47a5a;
  --rust-dim: #8f5a42;
}

html, body {
  height: 100%;
  font-family: 'JetBrains Mono', monospace;
  background: var(--bg);
  color: var(--text);
  font-size: 13px;
  line-height: 1.5;
}

/* Subtle texture overlay */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%' height='100%' filter='url(%23noise)'/%3E%3C/svg%3E");
  opacity: 0.03;
  pointer-events: none;
  z-index: 1000;
}

.app {
  display: grid;
  grid-template-rows: auto 1fr auto;
  height: 100vh;
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  gap: 16px;
}

/* HEADER */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 2px;
}

.logo {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo-icon {
  width: 36px;
  height: 36px;
  background: var(--gold);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: var(--bg);
  font-size: 16px;
  border-radius: 2px;
}

h1 {
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
  letter-spacing: 3px;
}

.tagline {
  font-size: 11px;
  color: var(--muted);
  margin-top: 2px;
  letter-spacing: 1px;
}

.status {
  font-size: 12px;
  color: var(--muted);
  padding: 8px 16px;
  background: var(--panel-alt);
  border-radius: 2px;
  border: 1px solid var(--border);
}

.status.running {
  color: var(--teal);
  border-color: var(--teal-dim);
}
.status.halted {
  color: var(--rust);
  border-color: var(--rust-dim);
}

/* MAIN GRID */
main {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr auto;
  gap: 16px;
  overflow: hidden;
}

/* PANELS */
.panel {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 2px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.panel-header {
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-secondary);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--panel-alt);
}

.panel-header .badge {
  font-size: 10px;
  color: var(--muted);
  background: var(--bg);
  padding: 4px 10px;
  border-radius: 2px;
  letter-spacing: 1px;
}

.panel-body {
  flex: 1;
  overflow-y: auto;
  padding: 0;
}

/* Scrollbar */
.panel-body::-webkit-scrollbar {
  width: 8px;
}
.panel-body::-webkit-scrollbar-track {
  background: var(--panel);
}
.panel-body::-webkit-scrollbar-thumb {
  background: var(--border-light);
  border-radius: 4px;
}

/* CODE EDITOR */
#code {
  width: 100%;
  height: 100%;
  border: none;
  background: transparent;
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  line-height: 1.9;
  padding: 20px;
  resize: none;
  outline: none;
}

#code::placeholder {
  color: var(--muted);
}

/* MEMORY VIEW */
.memory-table {
  width: 100%;
  font-size: 12px;
}

.memory-row {
  display: grid;
  grid-template-columns: 44px 1fr 56px 80px;
  border-bottom: 1px solid var(--border);
  transition: background 0.15s;
}

.memory-row:hover {
  background: var(--panel-alt);
}

.memory-row.current {
  background: var(--teal-dim);
  border-left: 3px solid var(--teal);
}

.memory-row.current .mem-addr { color: var(--teal); }
.memory-row.current .mem-instr { color: var(--text); }
.memory-row.current .mem-dec { color: var(--text); }
.memory-row.current .mem-bin { color: var(--text-secondary); }

.memory-row.header {
  background: var(--bg);
  color: var(--muted);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
  position: sticky;
  top: 0;
  z-index: 1;
  border-bottom: 1px solid var(--border-light);
}

.memory-row.header:hover {
  background: var(--bg);
}

.mem-addr, .mem-instr, .mem-dec, .mem-bin {
  padding: 10px 12px;
}

.mem-addr {
  color: var(--muted);
  text-align: right;
  font-size: 11px;
  border-right: 1px solid var(--border);
}

.mem-instr {
  color: var(--teal);
  padding-left: 16px;
}

.memory-row.is-data .mem-instr {
  color: var(--muted);
  font-style: italic;
}

.mem-dec {
  text-align: right;
  color: var(--gold);
  border-left: 1px solid var(--border);
}

.mem-bin {
  font-size: 11px;
  color: var(--muted);
  letter-spacing: 0.5px;
  border-left: 1px solid var(--border);
  font-variant-numeric: tabular-nums;
}

/* REGISTERS */
.registers-panel {
  grid-column: 1 / -1;
}

.registers-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  padding: 16px;
}

.register {
  background: var(--panel-alt);
  padding: 20px;
  text-align: center;
  border: 1px solid var(--border);
  border-radius: 2px;
}

.register-label {
  font-size: 10px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--muted);
  margin-bottom: 12px;
}

.register-value {
  font-size: 28px;
  font-weight: 500;
  color: var(--gold);
  font-variant-numeric: tabular-nums;
}

.register-binary {
  font-size: 11px;
  color: var(--muted);
  margin-top: 8px;
  letter-spacing: 1px;
  font-variant-numeric: tabular-nums;
}

.register.changed .register-value {
  color: var(--rust);
}

/* I/O Registers */
.register.io .register-value {
  font-size: 14px;
  color: var(--text-secondary);
}

.io-input {
  background: transparent;
  border: none;
  outline: none;
  font-family: inherit;
  font-size: 14px;
  color: var(--teal);
  width: 100%;
  text-align: center;
}

.io-input::placeholder {
  color: var(--muted);
}

.io-output {
  color: var(--gold);
  min-height: 21px;
}

.io-output:empty::before {
  content: '—';
  color: var(--muted);
}

/* FOOTER */
footer {
  display: flex;
  gap: 12px;
}

button {
  flex: 1;
  padding: 16px 24px;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--text-secondary);
  font-family: inherit;
  font-size: 12px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 2px;
  cursor: pointer;
  transition: all 0.15s;
  border-radius: 2px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

button:hover {
  background: var(--panel-alt);
  border-color: var(--border-light);
  color: var(--text);
}

button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

button:disabled:hover {
  background: var(--panel);
  border-color: var(--border);
  color: var(--text-secondary);
}

button.primary {
  background: var(--gold);
  border-color: var(--gold);
  color: var(--bg);
}

button.primary:hover {
  background: var(--gold-dim);
  border-color: var(--gold-dim);
}

button .shortcut {
  font-size: 10px;
  padding: 3px 8px;
  background: rgba(0,0,0,0.2);
  border-radius: 2px;
  opacity: 0.8;
}

/* RESPONSIVE */
@media (max-width: 900px) {
  main {
    grid-template-columns: 1fr;
  }
  .registers-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  .app {
    padding: 12px;
  }
}
</style>
</head>
<body>

<div class="app">
  <header>
    <div class="logo">
      <div class="logo-icon">H</div>
      <div>
        <h1>HYMN SIMULATOR</h1>
        <div class="tagline">Hypothetical Machine</div>
      </div>
    </div>
    <div class="status" id="status">Ready</div>
  </header>

  <main>
    <!-- CODE PANEL -->
    <div class="panel">
      <div class="panel-header">
        Source Code
        <span class="badge">Assembly</span>
      </div>
      <div class="panel-body">
        <textarea id="code" placeholder="# Add two numbers
load 5
add 6
stor 7
write
halt

# Data
10
25
0" spellcheck="false"></textarea>
      </div>
    </div>

    <!-- MEMORY PANEL -->
    <div class="panel">
      <div class="panel-header">
        Memory
        <span class="badge">30 Locations</span>
      </div>
      <div class="panel-body">
        <div class="memory-table" id="memory">
          <div class="memory-row header">
            <div class="mem-addr">Addr</div>
            <div class="mem-instr">Instruction</div>
            <div class="mem-dec">Dec</div>
            <div class="mem-bin">Binary</div>
          </div>
        </div>
      </div>
    </div>

    <!-- REGISTERS -->
    <div class="panel registers-panel">
      <div class="registers-grid">
        <div class="register" id="reg-pc">
          <div class="register-label">Program Counter</div>
          <div class="register-value">0</div>
          <div class="register-binary">00000</div>
        </div>
        <div class="register" id="reg-ac">
          <div class="register-label">Accumulator</div>
          <div class="register-value">0</div>
          <div class="register-binary">00000000</div>
        </div>
        <div class="register io">
          <div class="register-label">Input Buffer</div>
          <input type="text" class="io-input" id="input-buffer" placeholder="10, 25, 30">
        </div>
        <div class="register io">
          <div class="register-label">Output</div>
          <div class="io-output" id="output"></div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <button id="btn-load" class="primary">
      Load
      <span class="shortcut">⌘↵</span>
    </button>
    <button id="btn-step" disabled>
      Step
      <span class="shortcut">⌘S</span>
    </button>
    <button id="btn-run" disabled>
      Run
      <span class="shortcut">⌘R</span>
    </button>
    <button id="btn-reset" disabled>
      Reset
      <span class="shortcut">Esc</span>
    </button>
  </footer>
</div>

<script>
let state = null;
let prevAC = 0;

const $ = id => document.getElementById(id);

function toBinary(n, bits) {
  if (n < 0) n = (1 << bits) + n;
  return n.toString(2).padStart(bits, '0');
}

function initMemory() {
  const container = $('memory');
  const header = container.querySelector('.header');
  container.innerHTML = '';
  container.appendChild(header);

  for (let i = 0; i < 30; i++) {
    const row = document.createElement('div');
    row.className = 'memory-row';
    row.id = `mem-${i}`;
    row.innerHTML = `
      <div class="mem-addr">${i.toString().padStart(2, '0')}</div>
      <div class="mem-instr">halt 0</div>
      <div class="mem-dec">0</div>
      <div class="mem-bin">00000000</div>
    `;
    container.appendChild(row);
  }
}

function updateMemory(data) {
  for (let i = 0; i < 30; i++) {
    const row = $(`mem-${i}`);
    const mem = data.memory[i];

    const isData = mem.instr.startsWith('halt') && mem.decimal !== 0;

    row.classList.toggle('current', i === data.pc && !data.halted);
    row.classList.toggle('is-data', isData);

    row.querySelector('.mem-instr').textContent = isData ? `data` : mem.instr;
    row.querySelector('.mem-dec').textContent = mem.decimal;
    row.querySelector('.mem-bin').textContent = toBinary(mem.decimal, 8);
  }

  if (!data.halted) {
    const currentRow = $(`mem-${data.pc}`);
    currentRow?.scrollIntoView({ block: 'center', behavior: 'smooth' });
  }
}

function updateRegisters(data) {
  const pcReg = $('reg-pc');
  pcReg.querySelector('.register-value').textContent = data.pc;
  pcReg.querySelector('.register-binary').textContent = toBinary(data.pc, 5);

  const acReg = $('reg-ac');
  acReg.querySelector('.register-value').textContent = data.ac;
  acReg.querySelector('.register-binary').textContent = toBinary(data.ac, 8);

  if (state && data.ac !== prevAC) {
    acReg.classList.add('changed');
    setTimeout(() => acReg.classList.remove('changed'), 500);
  }
  prevAC = data.ac;

  $('output').textContent = data.output.join(', ');
}

function updateStatus(data) {
  const status = $('status');
  if (data.error) {
    status.textContent = data.error;
    status.className = 'status halted';
  } else if (data.halted) {
    status.textContent = 'Halted';
    status.className = 'status halted';
  } else {
    const mem = data.memory[data.pc];
    status.textContent = `Executing: ${mem.instr}`;
    status.className = 'status running';
  }
}

function updateUI(data) {
  state = data;
  updateMemory(data);
  updateRegisters(data);
  updateStatus(data);

  $('btn-step').disabled = data.halted || data.error;
  $('btn-run').disabled = data.halted || data.error;
}

function setMode(mode) {
  if (mode === 'edit') {
    $('btn-load').disabled = false;
    $('btn-load').classList.add('primary');
    $('btn-step').disabled = true;
    $('btn-run').disabled = true;
    $('btn-reset').disabled = true;
    $('code').disabled = false;
    $('input-buffer').disabled = false;
    $('status').textContent = 'Ready';
    $('status').className = 'status';
  } else {
    $('btn-load').disabled = true;
    $('btn-load').classList.remove('primary');
    $('btn-step').disabled = false;
    $('btn-run').disabled = false;
    $('btn-reset').disabled = false;
    $('code').disabled = true;
    $('input-buffer').disabled = true;
  }
}

async function load() {
  const code = $('code').value;
  const inputStr = $('input-buffer').value;
  const input = inputStr.split(',').map(s => s.trim()).filter(s => s);

  try {
    const res = await fetch('/api/load', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, input })
    });
    const data = await res.json();

    if (data.error) {
      $('status').textContent = data.error;
      $('status').className = 'status halted';
      return;
    }

    prevAC = 0;
    state = null;
    setMode('loaded');
    updateUI(data);

  } catch (e) {
    $('status').textContent = 'Connection error';
    $('status').className = 'status halted';
  }
}

async function step() {
  try {
    const res = await fetch('/api/step', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    const data = await res.json();
    if (!data.error || state) {
      updateUI(data);
    }
  } catch (e) {
    $('status').textContent = 'Connection error';
    $('status').className = 'status halted';
  }
}

async function run() {
  try {
    const res = await fetch('/api/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    const data = await res.json();
    if (!data.error || state) {
      updateUI(data);
    }
  } catch (e) {
    $('status').textContent = 'Connection error';
    $('status').className = 'status halted';
  }
}

async function reset() {
  await fetch('/api/reset', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({})
  });
  state = null;
  prevAC = 0;
  $('output').textContent = '';
  initMemory();
  setMode('edit');
}

$('btn-load').onclick = load;
$('btn-step').onclick = step;
$('btn-run').onclick = run;
$('btn-reset').onclick = reset;

document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && e.metaKey) {
    e.preventDefault();
    if (!$('btn-load').disabled) load();
  }
  if (e.key === 's' && e.metaKey) {
    e.preventDefault();
    if (!$('btn-step').disabled) step();
  }
  if (e.key === 'r' && e.metaKey) {
    e.preventDefault();
    if (!$('btn-run').disabled) run();
  }
  if (e.key === 'Escape') {
    if (!$('btn-reset').disabled) reset();
  }
});

initMemory();
setMode('edit');
</script>

</body>
</html>
